<p align="center">
  <img src="https://img.shields.io/badge/Python-3.12-3776AB?style=for-the-badge&logo=python&logoColor=white" />
  <img src="https://img.shields.io/badge/FastAPI-0.115-009688?style=for-the-badge&logo=fastapi&logoColor=white" />
  <img src="https://img.shields.io/badge/OpenAI-GPT--4o-412991?style=for-the-badge&logo=openai&logoColor=white" />
  <img src="https://img.shields.io/badge/Playwright-1.50-2EAD33?style=for-the-badge&logo=playwright&logoColor=white" />
  <img src="https://img.shields.io/badge/PostgreSQL-16-4169E1?style=for-the-badge&logo=postgresql&logoColor=white" />
  <img src="https://img.shields.io/badge/Docker-Ready-2496ED?style=for-the-badge&logo=docker&logoColor=white" />
</p>

<p align="center">
  <b>🇷🇺 <a href="#ru">Русский</a></b> · <b>🇬🇧 <a href="README_EN.md">English</a></b>
</p>

---

<a id="ru"></a>

# Avtor24 AI Bot — Полная автоматизация фриланс-платформы

> Автономная система, которая находит заказы, оценивает их, ставит ставки, генерирует академические работы с помощью GPT-4o, проверяет антиплагиат, сдаёт заказчику и ведёт диалог — **без участия человека**.

## Оглавление

- [Обзор](#обзор)
- [Ключевые метрики](#ключевые-метрики)
- [Архитектура](#архитектура)
- [Пайплайн обработки заказа](#пайплайн-обработки-заказа)
- [Технологический стек](#технологический-стек)
- [Основные модули](#основные-модули)
- [Веб-дашборд](#веб-дашборд)
- [Генерация работ](#генерация-работ)
- [Антиплагиат](#антиплагиат)
- [Песочница для кода](#песочница-для-кода)
- [Антибан-система](#антибан-система)
- [Тестирование](#тестирование)
- [Запуск](#запуск)
- [Деплой](#деплой)
- [Структура проекта](#структура-проекта)

---

## Обзор

**Avtor24 AI Bot** — это production-ready система, автоматизирующая полный цикл работы автора на платформе avtor24.ru. Бот работает 24/7, самостоятельно обрабатывая заказы от поиска до сдачи готовой работы.

### Что делает система:

1. **Сканирует** ленту заказов на avtor24.ru каждые 60 секунд
2. **Оценивает** каждый заказ через GPT-4o-mini (скоринг 0–100)
3. **Ставит ставки** с AI-генерированными комментариями
4. **Генерирует работы** любого типа (эссе, курсовые, ВКР, код и др.)
5. **Проверяет антиплагиат** и при необходимости выполняет рерайт
6. **Формирует DOCX** по ГОСТу (титульный лист, содержание, нумерация)
7. **Сдаёт работу** заказчику в два этапа (промежуточный → окончательный)
8. **Ведёт переписку** с заказчиком от имени автора
9. **Предоставляет дашборд** с аналитикой, уведомлениями и управлением

---

## Ключевые метрики

| Метрика | Значение |
|---------|----------|
| Исходный код (Python) | **9 100+ строк** |
| Тестовый код | **5 590 строк** |
| Общий объём (вкл. Node.js, HTML) | **15 000+ строк** |
| Python-модулей | 46 файлов |
| Поддерживаемых типов работ | 15+ |
| Системных промптов | 13 |
| Таблиц в БД | 8 |
| Страниц дашборда | 8 |
| API-эндпоинтов | 30+ |
| WebSocket-потоков | 2 (уведомления, логи) |
| Тестовых модулей | 9 файлов |

---

## Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                        AVTOR24 AI BOT                           │
├─────────────┬──────────────┬──────────────┬─────────────────────┤
│  SCRAPER    │  ANALYZER    │  GENERATOR   │  DASHBOARD          │
│             │              │              │                     │
│ Playwright  │ GPT-4o-mini  │ GPT-4o       │ FastAPI + Alpine.js │
│ + Proxy RU  │ Scoring      │ 15+ типов    │ WebSocket реалтайм  │
│ + Antiban   │ Pricing      │ Stepwise     │ Chart.js аналитика  │
│ + Cookies   │ File Analyze │ DOCX по ГОСТ │ JWT авторизация     │
├─────────────┼──────────────┼──────────────┼─────────────────────┤
│  ANTIPLAGIAT│  CHAT AI     │  SANDBOX     │  NOTIFICATIONS      │
│             │              │              │                     │
│ text.ru API │ GPT-4o-mini  │ Docker       │ WebSocket push      │
│ ETXT API    │ Авто-ответы  │ Python/JS/   │ Звук + Push API     │
│ AI Rewriter │ Intent detect│ Java/C++/C#  │ Колокольчик + бейдж │
├─────────────┴──────────────┴──────────────┴─────────────────────┤
│                      DATABASE (PostgreSQL / SQLite)              │
│  Orders · Messages · ActionLogs · DailyStats · Notifications    │
│  BotSettings · ApiUsage                                         │
├─────────────────────────────────────────────────────────────────┤
│              DEPLOYMENT: Docker + Railway (auto-migrations)      │
└─────────────────────────────────────────────────────────────────┘
```

---

## Пайплайн обработки заказа

```
 ① СКАНИРОВАНИЕ           ② АНАЛИЗ               ③ СТАВКА
 ┌──────────────┐    ┌──────────────────┐    ┌──────────────────┐
 │ Парсинг      │───▶│ AI-скоринг       │───▶│ Расчёт цены      │
 │ ленты заказов│    │ (score ≥ 60)     │    │ + AI-комментарий  │
 │ каждые 60 сек│    │ Анализ файлов    │    │ Постановка ставки │
 └──────────────┘    └──────────────────┘    └──────────────────┘
                                                      │
 ┌─────────────────────────────────────────────────────┘
 ▼
 ④ ГЕНЕРАЦИЯ              ⑤ АНТИПЛАГИАТ          ⑥ DOCX
 ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐
 │ План → Разделы   │───▶│ Выборочная       │───▶│ Титульный лист   │
 │ → Расширение     │    │ проверка → Полная│    │ Содержание       │
 │ до целевого объёма│    │ Рерайт (до 3x)  │    │ Times New Roman  │
 └──────────────────┘    └──────────────────┘    │ ГОСТ оформление  │
                                                  └──────────────────┘
                                                          │
 ┌────────────────────────────────────────────────────────┘
 ▼
 ⑦ ПРОМЕЖУТОЧНАЯ СДАЧА    ⑧ ОДОБРЕНИЕ            ⑨ ФИНАЛЬНАЯ СДАЧА
 ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐
 │ Загрузка файла   │───▶│ AI-детекция      │───▶│ Загрузка как     │
 │ + сопроводительное│    │ intent одобрения │    │ Окончательный    │
 │ сообщение        │    │ в чате заказчика │    │ + просьба отзыва │
 └──────────────────┘    └──────────────────┘    └──────────────────┘
```

---

## Технологический стек

| Компонент | Технология | Назначение |
|-----------|-----------|------------|
| **Backend** | Python 3.12, FastAPI, APScheduler | Серверная часть, фоновые задачи |
| **Web Scraping** | Playwright (Chromium) | Автоматизация браузера |
| **AI/ML** | OpenAI API (GPT-4o, GPT-4o-mini) | Генерация, анализ, чат |
| **Database** | PostgreSQL + SQLAlchemy + Alembic | Хранение данных, миграции |
| **Documents** | docx-js (Node.js 22) | Генерация DOCX по ГОСТу |
| **Frontend** | Alpine.js + Tailwind CSS + Chart.js | Интерактивный дашборд |
| **Real-time** | WebSocket (FastAPI) | Уведомления, логи |
| **Auth** | JWT + bcrypt + httpOnly cookies | Безопасная авторизация |
| **Testing** | pytest + pytest-asyncio | 5 590 строк тестов |
| **Deploy** | Docker, docker-compose, Railway | Контейнеризация, хостинг |
| **Proxy** | SOCKS5 (российский резидентный) | Обход гео-ограничений |

---

## Основные модули

### Скрапер (`src/scraper/`) — 1 290 строк

Полная автоматизация взаимодействия с React SPA avtor24.ru:

- **browser.py** — Playwright-менеджер с прокси, ротацией User-Agent (7 вариантов), рандомизацией viewport, сохранением cookies
- **auth.py** — Авторизация с поддержкой countrylock (телефонная верификация)
- **orders.py** — Парсинг ленты заказов (React SPA с `styled-components`)
- **order_detail.py** — Извлечение 15+ полей из карточки заказа
- **bidder.py** — Постановка ставок с AI-генерированными комментариями
- **chat.py** — Чтение/отправка сообщений, двухэтапная сдача, детекция одобрения
- **file_handler.py** — Загрузка файлов (промежуточный + окончательный варианты)
- **antiban.py** — Детекция бана, лимит ставок/день, rate limiting

### Анализатор (`src/analyzer/`) — 670 строк

- **order_scorer.py** — AI-скоринг заказов (0–100, can_do, estimated_time, reason)
- **price_calculator.py** — Расчёт цены (от бюджета / от средней ставки / по формуле)
- **file_analyzer.py** — Извлечение текста из PDF/DOCX, суммаризация методичек
- **field_extractor.py** — Парсинг требований к форматированию, структуре, спецтребованиям

### Генератор (`src/generator/`) — 1 440 строк

- **router.py** — Маппинг 30+ типов работ на 15 генераторов
- **stepwise.py** — Универсальный движок: план → разделы → расширение до целевого объёма
- **Специализированные генераторы:** эссе, рефераты, курсовые, ВКР, контрольные, код, презентации, переводы, копирайтинг, бизнес-планы, отчёты по практике, рецензии, повышение уникальности
- **prompts/** — 13 системных промптов для каждого типа

### Формирование DOCX (`src/docgen/`) — 270 строк

- Генерация через Node.js subprocess (docx-js)
- Титульный лист, автосодержание с номерами страниц
- Times New Roman 12–14pt, интервал 1.5, поля по ГОСТу
- HeadingLevel стили, нумерация страниц, библиография

### Антиплагиат (`src/antiplagiat/`) — 610 строк

- **checker.py** — Оптимизированная проверка: выборочная → полная при необходимости
- **rewriter.py** — AI-рерайт абзацев с низкой уникальностью (до 3 итераций)
- **textru.py** — Интеграция с text.ru API
- **etxt.py** — Интеграция с ETXT API

### AI-чат (`src/chat_ai/`) — 400 строк

- Генерация ответов от имени автора (2–3 предложения, без упоминания AI)
- Детекция intent одобрения для двухэтапной сдачи
- Контекстные ответы (статус заказа, дедлайн, требования)

### Песочница (`src/sandbox/`) — 330 строк

- Docker-контейнеры для исполнения кода (Python, JS, Java, C++, C#)
- Таймаут 30 сек, лимит памяти 256MB, без сети, read-only FS
- AI-цикл исправления ошибок (до 5 итераций)

---

## Веб-дашборд

Полноценный SPA — **единственный центр управления** системой.

### Страницы:

| Страница | Функциональность |
|----------|-----------------|
| **Обзор** | Виджеты дохода (сегодня/неделя/всё время), активные заказы, лента событий в реалтайме, графики (Chart.js), статус бота, кнопка Старт/Стоп |
| **Заказы** | Таблица с фильтрацией/сортировкой/пагинацией, статусы с цветными бейджами, детальная карточка, перегенерация, экспорт CSV |
| **Аналитика** | Доход по дням, конверсионная воронка, распределение по типам работ, потребление API-токенов, ROI-трекинг |
| **Уведомления** | Реалтайм через WebSocket, колокольчик с бейджем, звуковые оповещения, browser push-notifications |
| **Логи** | Реалтайм лог действий бота (как терминал), фильтрация по типу, поиск, экспорт |
| **Настройки** | Все параметры бота через UI: интервалы, фильтры, ценообразование, лимиты, промпты |
| **Чаты** | Мессенджер-интерфейс, override AI-ответов, ручные сообщения |

### Технологии фронтенда:

- **Alpine.js** — реактивность без тяжёлых фреймворков
- **Tailwind CSS** — utility-first стилизация
- **Chart.js** — графики и аналитика
- **WebSocket** — мгновенные обновления без перезагрузки

---

## Генерация работ

### Пошаговый алгоритм (Stepwise Generation):

```
1. ПЛАНИРОВАНИЕ
   GPT-4o → JSON-план с разделами и целевым объёмом слов

2. ГЕНЕРАЦИЯ ПО РАЗДЕЛАМ
   Для каждого раздела → отдельный вызов GPT-4o с контекстом:
   - Тема, предмет, описание заказа
   - Методичка (если есть)
   - Предыдущие разделы (суммари)
   - Целевой объём раздела

3. РАСШИРЕНИЕ
   Если суммарный объём < целевого:
   → GPT-4o дополняет разделы с наименьшим объёмом

4. ПОСТОБРАБОТКА
   - Очистка от Markdown-артефактов
   - Удаление дублирующихся заголовков
   - Генерация библиографии (ГОСТ Р 7.0.5-2008)
```

### Поддерживаемые типы:

| Тип работы | Объём по умолчанию | Особенности |
|-----------|-------------------|-------------|
| Эссе | 5 стр. | Свободная структура, авторский стиль |
| Реферат | 10–12 стр. | Введение + 2-3 главы + заключение |
| Курсовая | 25 стр. | 3 главы с подразделами, библиография 15–25 источников |
| ВКР/Диплом | 60 стр. | 3-4 главы, 30–50 источников, ~20-30 API-вызовов |
| Контрольная | 8 стр. | Ответы на вопросы, решение задач |
| Код | — | Генерация + запуск в песочнице + AI fix loop |
| Презентация | 15 слайдов | Структурированный контент для слайдов |
| Перевод | 10 стр. | EN→RU / RU→EN |
| Бизнес-план | 15 стр. | Маркетинг, финансы, SWOT |
| Отчёт по практике | 20 стр. | Дневник практики, выводы |

---

## Антиплагиат

### Оптимизированная стратегия проверки:

```
1. ВЫБОРОЧНАЯ ПРОВЕРКА (экономия API)
   → 2-3 случайных фрагмента по 1500-2000 символов
   → Если средняя уникальность ≥ порог + 5% → ПРИНЯТО

2. ПОЛНАЯ ПРОВЕРКА (если выборочная не прошла)
   → Весь текст через text.ru / ETXT API

3. РЕРАЙТ (если уникальность < порога)
   → GPT-4o перефразирует абзацы с заимствованиями
   → Повторная проверка
   → До 3 итераций
```

---

## Песочница для кода

```
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│   GPT-4o     │────▶│ Docker Container │────▶│   Результат  │
│ генерирует   │     │ --memory=256m    │     │ stdout/stderr│
│ код          │     │ --cpus=1         │     │ exit_code    │
└──────────────┘     │ --network=none   │     └──────┬───────┘
       ▲             │ --read-only      │            │
       │             │ timeout=30s      │            │ Ошибка?
       │             └─────────────────┘            │
       └────────────── GPT-4o правит ◀──────────────┘
                      (до 5 попыток)
```

**Языки:** Python 3.12 · JavaScript (Node.js 20) · Java 17 · C++ (g++ 13) · C# (.NET 8)

---

## Антибан-система

| Механизм | Реализация |
|----------|-----------|
| Задержки | 30–120 сек между действиями (рандомизированные) |
| User-Agent | Ротация из 7 реальных Chrome UA |
| Viewport | Рандомизация: 1920x1080, 1366x768, 1536x864 |
| Лимит ставок | Не более 20 в день |
| Детекция бана | Мониторинг 403/captcha → пауза 30 мин |
| Retry | Экспоненциальный backoff (3 попытки) |
| Прокси | Российский резидентный SOCKS5 |
| Поведение | Имитация человеческих действий (ввод, скролл) |
| Cookies | Персистентная сессия (cookies.json) |

---

## Тестирование

**5 590 строк тестового кода** в 9 модулях:

| Модуль | Строк | Покрытие |
|--------|-------|----------|
| `test_integration.py` | 1 269 | Полный пайплайн end-to-end |
| `test_scraper.py` | 806 | Парсинг с реальными HTML-фикстурами |
| `test_generator.py` | 778 | Все 15+ генераторов |
| `test_dashboard.py` | 619 | Все API-эндпоинты дашборда |
| `test_analyzer.py` | 588 | Скоринг, ценообразование, анализ файлов |
| `test_antiplagiat.py` | 525 | Проверка уникальности + рерайт |
| `test_sandbox.py` | 494 | Исполнение кода в Docker |
| `test_chat_ai.py` | 320 | Генерация ответов, детекция intent |
| `test_database.py` | 161 | ORM, миграции, CRUD |

### Стратегия моков:

- **OpenAI API** → фиксированные ответы (без трат токенов)
- **Playwright** → реальные HTML-фикстуры с avtor24.ru
- **Антиплагиат API** → фиксированные проценты уникальности
- **PostgreSQL** → SQLite in-memory для скорости

```bash
# Запуск всех тестов
pytest tests/ -v

# Запуск конкретного модуля
pytest tests/test_generator.py -v

# С live API (реальные вызовы OpenAI)
pytest tests/ -v -m live_api
```

---

## Запуск

### Требования

- Python 3.12+
- Node.js 20+
- Docker (для песочницы кода)
- PostgreSQL (production) или SQLite (development)

### 1. Установка зависимостей

```bash
git clone <repo-url>
cd avtor24-bot

pip install -r requirements.txt
npm install
playwright install chromium
```

### 2. Конфигурация

```bash
cp .env.example .env
# Заполнить .env своими ключами
```

<details>
<summary>Переменные окружения</summary>

| Переменная | Описание | По умолчанию |
|---|---|---|
| `AVTOR24_EMAIL` | Email для входа на avtor24.ru | — |
| `AVTOR24_PASSWORD` | Пароль от аккаунта | — |
| `OPENAI_API_KEY` | Ключ OpenAI API | — |
| `OPENAI_MODEL_MAIN` | Модель для генерации | `gpt-4o` |
| `OPENAI_MODEL_FAST` | Модель для анализа/чата | `gpt-4o-mini` |
| `TEXTRU_API_KEY` | Ключ text.ru API | — |
| `ETXT_API_KEY` | Ключ ETXT API | — |
| `MIN_UNIQUENESS` | Мин. порог уникальности (%) | `50` |
| `DASHBOARD_USERNAME` | Логин дашборда | `admin` |
| `DASHBOARD_PASSWORD_HASH` | bcrypt-хеш пароля | — |
| `DASHBOARD_SECRET_KEY` | Секрет для JWT | — |
| `DATABASE_URL` | URL базы данных | `sqlite+aiosqlite:///./avtor24.db` |
| `PROXY_RU` | Российский прокси (socks5) | — |
| `MAX_CONCURRENT_ORDERS` | Макс. заказов одновременно | `5` |
| `AUTO_BID` | Автоматические ставки | `true` |
| `MIN_PRICE_RUB` / `MAX_PRICE_RUB` | Диапазон цен | `300` / `50000` |
| `SCAN_INTERVAL_SECONDS` | Интервал сканирования | `60` |
| `SPEED_LIMIT_MIN_DELAY` / `MAX_DELAY` | Задержки антибана | `30` / `120` |

</details>

### 3. Миграции и запуск

```bash
# Миграции
python -m alembic upgrade head

# Запуск сервера (дашборд + API + бот)
python -m uvicorn src.main:app --host 0.0.0.0 --port 8000

# Или standalone мониторинг (без дашборда)
python scripts/run_monitor.py
```

Дашборд: `http://localhost:8000/dashboard/`

### 4. Docker

```bash
docker-compose up -d
```

---

## Деплой

### Railway (production)

1. Подключить GitHub-репозиторий к Railway
2. Добавить PostgreSQL-плагин
3. Установить переменные окружения
4. Railway автоматически соберёт и запустит:

```
Docker build → alembic upgrade head → uvicorn src.main:app
```

### Healthcheck

```
GET /health → {"status": "ok", "uptime": 3600, "bot_running": true}
```

---

## Структура проекта

```
avtor24-bot/
├── src/                              # Исходный код (9 100+ строк)
│   ├── main.py                       # FastAPI + APScheduler оркестратор
│   ├── config.py                     # Конфигурация из .env (Pydantic Settings)
│   ├── ai_client.py                  # OpenAI API обёртка с трекингом токенов
│   ├── pipeline.py                   # Пайплайн обработки заказа
│   │
│   ├── scraper/                      # Парсинг Автор24 (Playwright)
│   │   ├── browser.py                # Browser manager (proxy, UA, cookies)
│   │   ├── auth.py                   # Авторизация + countrylock
│   │   ├── orders.py                 # Парсинг ленты заказов
│   │   ├── order_detail.py           # Парсинг деталей заказа
│   │   ├── bidder.py                 # Постановка ставок
│   │   ├── chat.py                   # Чтение/отправка сообщений + двухэтапная сдача
│   │   ├── file_handler.py           # Загрузка файлов
│   │   └── antiban.py                # Детекция бана, rate limiting
│   │
│   ├── analyzer/                     # AI-анализ заказов
│   │   ├── order_scorer.py           # Скоринг (GPT-4o-mini)
│   │   ├── price_calculator.py       # Расчёт оптимальной цены
│   │   ├── file_analyzer.py          # Извлечение текста из PDF/DOCX
│   │   └── field_extractor.py        # Парсинг требований
│   │
│   ├── generator/                    # Генерация работ (15+ типов)
│   │   ├── router.py                 # Роутер по типу работы
│   │   ├── stepwise.py               # Пошаговый движок генерации
│   │   ├── essay.py ... review.py    # Специализированные генераторы
│   │   └── prompts/                  # 13 системных промптов
│   │
│   ├── docgen/                       # Генерация DOCX по ГОСТу
│   │   ├── builder.py                # Node.js subprocess (docx-js)
│   │   └── formatter.py              # Нормализация текста
│   │
│   ├── antiplagiat/                  # Антиплагиат
│   │   ├── checker.py                # Оптимизированная проверка
│   │   ├── rewriter.py               # AI-рерайт
│   │   ├── textru.py                 # text.ru API
│   │   └── etxt.py                   # ETXT API
│   │
│   ├── chat_ai/                      # AI-ответы заказчикам
│   │   └── responder.py              # Генерация ответов + детекция intent
│   │
│   ├── sandbox/                      # Песочница для кода (Docker)
│   │   ├── executor.py               # Запуск кода в контейнере
│   │   └── languages.py              # Конфигурации языков
│   │
│   ├── dashboard/                    # Веб-дашборд
│   │   ├── app.py                    # FastAPI роутер (30+ эндпоинтов)
│   │   ├── auth.py                   # JWT авторизация
│   │   └── static/                   # SPA (HTML + Tailwind + Alpine.js)
│   │
│   ├── notifications/                # Реалтайм-уведомления (WebSocket)
│   │   ├── websocket.py              # WebSocket manager
│   │   └── events.py                 # Генерация событий
│   │
│   └── database/                     # PostgreSQL ORM
│       ├── models.py                 # SQLAlchemy модели (8 таблиц)
│       ├── crud.py                   # CRUD + аналитические запросы
│       └── connection.py             # Подключение к БД
│
├── scripts/
│   ├── generate_docx.js              # Node.js генерация DOCX
│   └── run_monitor.py                # Standalone мониторинг
│
├── tests/                            # Тесты (5 590 строк)
│   ├── fixtures/                     # Реальные HTML-фикстуры с avtor24.ru
│   └── test_*.py                     # 9 тестовых модулей
│
├── alembic/                          # Миграции БД
├── Dockerfile                        # Docker-образ
├── docker-compose.yml                # Docker Compose + PostgreSQL
├── railway.toml                      # Railway конфиг
├── requirements.txt                  # Python зависимости
└── package.json                      # Node.js зависимости (docx-js)
```

---

## База данных

8 таблиц, управляемых через Alembic-миграции:

| Таблица | Назначение |
|---------|-----------|
| `orders` | Заказы (30+ полей: данные, ставка, статус, финансы, AI-метрики) |
| `messages` | История чатов с заказчиками |
| `action_logs` | Лог всех действий бота |
| `daily_stats` | Агрегированная дневная статистика |
| `notifications` | Уведомления дашборда (JSONB body) |
| `bot_settings` | Персистентные настройки (редактируются через UI) |
| `api_usage` | Детальный трекинг токенов OpenAI (по модели и назначению) |

---

## Лицензия

Приватный проект. Все права защищены.
