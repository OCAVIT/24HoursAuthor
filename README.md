# Avtor24 AI Bot

Полностью автоматизированная система для работы на платформе avtor24.ru.

## Возможности

- Мониторинг и парсинг новых заказов с avtor24.ru
- AI-скоринг заказов (GPT-4o-mini)
- Автоматическая постановка ставок с AI-генерацией комментариев
- Генерация работ всех типов (эссе, рефераты, курсовые, ВКР, код и др.)
- Пошаговая генерация: план -> разделы -> расширение до целевого объёма
- DOCX по ГОСТу: титульный лист, содержание с номерами страниц, HeadingLevel стили
- Проверка антиплагиата (text.ru, ETXT) с оптимизацией (выборочная проверка)
- Авторерайт при низкой уникальности
- AI-чат с заказчиком (уточняющие вопросы, правки, просьба об отзыве)
- Двухэтапная сдача: промежуточный вариант -> одобрение -> окончательный
- Автоматическая просьба оставить отзыв после сдачи
- Песочница для кода (Python, JS, Java, C++)
- Веб-дашборд с аналитикой, реалтайм-уведомлениями и управлением ботом
- Кнопка остановки/запуска бота на дашборде

## Стек

- **Backend:** Python 3.12, FastAPI, APScheduler
- **Scraping:** Playwright (Chromium) с российским прокси
- **AI:** OpenAI API (GPT-4o для генерации, GPT-4o-mini для анализа/чата)
- **БД:** PostgreSQL + SQLAlchemy (async) + Alembic
- **Документы:** docx-js (Node.js) — DOCX по ГОСТу
- **Frontend:** HTML5, Tailwind CSS, Alpine.js, Chart.js, WebSocket
- **Деплой:** Docker, Railway

## Запуск локально

### 1. Клонировать и установить зависимости

```bash
git clone <repo-url>
cd avtor24-bot

pip install -r requirements.txt
npm install
playwright install chromium
```

### 2. Настроить переменные окружения

```bash
cp .env.example .env
# Заполнить .env своими ключами и учётными данными
```

### 3. Запустить БД и миграции

```bash
# PostgreSQL должен быть запущен
# Или использовать SQLite для разработки (по умолчанию в config.py)
python -m alembic upgrade head
```

### 4. Запустить приложение

```bash
python -m uvicorn src.main:app --host 0.0.0.0 --port 8000
```

Дашборд: http://localhost:8000/dashboard/

### 5. Запустить мониторинг (standalone)

```bash
python scripts/run_monitor.py
```

Скрипт мониторинга работает автономно — проверяет заказы, генерирует работы, отвечает в чат, загружает файлы.

### 6. Запустить тесты

```bash
pytest tests/ -v
```

## Пайплайн обработки заказа

```
1. Сканирование ленты заказов (каждые 60 сек)
2. AI-скоринг (GPT-4o-mini): score >= 60 → ставка
3. Расчёт оптимальной цены
4. Постановка ставки + уточняющее сообщение в чат
5. Ожидание принятия заказа
6. Генерация работы (пошагово: план → разделы → расширение)
7. Проверка антиплагиата (выборочная → полная при необходимости)
8. Сборка DOCX по ГОСТу
9. Загрузка как Промежуточный вариант + сопроводительное сообщение
10. Ожидание одобрения заказчика (AI-детекция intent)
11. Загрузка как Окончательный + просьба об отзыве
```

## Переменные окружения

| Переменная | Описание | По умолчанию |
|---|---|---|
| `AVTOR24_EMAIL` | Email для входа на avtor24.ru | — |
| `AVTOR24_PASSWORD` | Пароль от аккаунта | — |
| `AVTOR24_BASE_URL` | Базовый URL | `https://avtor24.ru` |
| `OPENAI_API_KEY` | Ключ OpenAI API | — |
| `OPENAI_MODEL_MAIN` | Модель для генерации | `gpt-4o` |
| `OPENAI_MODEL_FAST` | Модель для анализа/чата | `gpt-4o-mini` |
| `TEXTRU_API_KEY` | Ключ text.ru API | — |
| `ETXT_API_KEY` | Ключ ETXT API | — |
| `MIN_UNIQUENESS` | Мин. порог уникальности (%) | `50` |
| `DASHBOARD_USERNAME` | Логин дашборда | `admin` |
| `DASHBOARD_PASSWORD_HASH` | bcrypt-хеш пароля | — |
| `DASHBOARD_SECRET_KEY` | Секрет для JWT | — |
| `DATABASE_URL` | URL PostgreSQL | `sqlite+aiosqlite:///./avtor24.db` |
| `PROXY_RU` | Российский прокси (socks5) | — |
| `MAX_CONCURRENT_ORDERS` | Макс. заказов одновременно | `5` |
| `AUTO_BID` | Автоматические ставки | `true` |
| `MIN_PRICE_RUB` | Мин. цена заказа | `300` |
| `MAX_PRICE_RUB` | Макс. цена заказа | `50000` |
| `SCAN_INTERVAL_SECONDS` | Интервал сканирования | `60` |
| `SPEED_LIMIT_MIN_DELAY` | Мин. задержка между действиями (сек) | `30` |
| `SPEED_LIMIT_MAX_DELAY` | Макс. задержка (сек) | `120` |

## Деплой на Railway

### 1. Создать проект на Railway

- Подключить GitHub-репозиторий
- Добавить PostgreSQL плагин

### 2. Установить переменные окружения

В настройках Railway-сервиса добавить все переменные из таблицы выше.

`DATABASE_URL` будет автоматически предоставлен плагином PostgreSQL.

### 3. Деплой

Railway автоматически соберёт Docker-образ и запустит приложение.

При каждом push в main:
1. Docker build
2. `alembic upgrade head` (миграции)
3. `uvicorn src.main:app` (сервер)

### Healthcheck

```
GET /health → {"status": "ok", "uptime": ..., "bot_running": true}
```

## Дашборд

Веб-интерфейс для управления ботом:

- **Обзор** — виджеты дохода, активные заказы, лента событий, графики
- **Заказы** — таблица с фильтрами, детали заказа, перегенерация, остановка
- **Аналитика** — доход по дням, ROI, потребление API токенов
- **Уведомления** — реалтайм через WebSocket + колокольчик
- **Логи** — реалтайм лог действий бота (терминал)
- **Настройки** — все параметры бота через UI
- **Чаты** — мессенджер с переписками, ручные ответы (override AI)
- **Кнопка Старт/Стоп** — управление ботом из UI

## Антибан

- Случайные задержки между всеми действиями (30-120 сек)
- Ротация User-Agent (7 вариантов Chrome)
- Российский резидентный прокси
- Имитация человеческого поведения (плавное движение мыши, посимвольный ввод)
- Лимит: не более 20 ставок в день
- Мониторинг 403/captcha -> автоматическая пауза 30 мин + уведомление
- Retry с экспоненциальным backoff (3 попыток)
- Graceful shutdown (завершение текущих задач перед остановкой)

## Оптимизация антиплагиата

Для экономии API-расхода text.ru:
- Сначала проверяются 2-3 случайных фрагмента по 1500-2000 символов из середины работы
- Если средняя уникальность >= порог + 5% — полная проверка не выполняется
- Если < порога + 5% — запускается полная проверка

## Структура проекта

```
src/
├── main.py              — FastAPI + APScheduler оркестратор
├── config.py            — Конфигурация из .env
├── ai_client.py         — OpenAI API обёртка с трекингом токенов
├── scraper/             — Парсинг Автор24 (Playwright)
│   ├── auth.py          — Авторизация + cookies
│   ├── orders.py        — Парсинг ленты заказов
│   ├── order_detail.py  — Парсинг деталей заказа
│   ├── bidder.py        — Постановка ставок
│   ├── chat.py          — Чтение/отправка сообщений
│   ├── file_handler.py  — Загрузка файлов (промежуточный/окончательный)
│   └── browser.py       — Playwright browser manager
├── analyzer/            — AI-скоринг + расчёт цен + анализ файлов
├── generator/           — Генерация работ (15+ типов)
│   ├── router.py        — Роутер по типу работы
│   ├── stepwise.py      — Пошаговая генерация (план → разделы → расширение)
│   └── prompts/         — Системные промпты для каждого типа
├── docgen/              — Сборка DOCX по ГОСТу
├── antiplagiat/         — Проверка уникальности + рерайт
│   └── checker.py       — Оптимизированная проверка (выборочная + полная)
├── chat_ai/             — AI-ответы заказчикам
│   └── responder.py     — Генерация ответов + детекция одобрения
├── sandbox/             — Песочница для кода (Docker)
├── notifications/       — WebSocket уведомления
├── dashboard/           — Веб-дашборд (API + SPA)
└── database/            — SQLAlchemy ORM + CRUD + Alembic миграции

scripts/
├── generate_docx.js     — Node.js генерация DOCX (HeadingLevel, TOC)
└── run_monitor.py       — Standalone мониторинг + полный пайплайн
```

## Лицензия

Приватный проект. Все права защищены.
