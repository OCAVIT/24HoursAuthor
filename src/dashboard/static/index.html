<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avtor24 Bot — Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        accent: { 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6' },
                        surface: { 700: '#2a2a3c', 750: '#232336', 800: '#1e1e2e', 850: '#181826', 900: '#11111b' }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/dashboard/static/styles.css">
</head>
<body class="bg-surface-900 text-gray-200 min-h-screen" x-data="dashboard()" x-init="init()">

    <!-- Mobile Sidebar Overlay -->
    <div x-show="sidebarOpen" x-transition:enter="transition-opacity ease-out duration-200"
         x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-in duration-150"
         x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/60 z-40 lg:hidden" @click="sidebarOpen=false"></div>

    <!-- Sidebar -->
    <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'"
           class="fixed top-0 left-0 z-50 w-64 h-full bg-surface-800 border-r border-gray-800/60 flex flex-col transition-transform duration-200 lg:translate-x-0">

        <!-- Brand -->
        <div class="flex items-center gap-3 px-5 py-5 border-b border-gray-800/60">
            <div class="w-9 h-9 rounded-xl bg-accent-600/20 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-accent-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
            </div>
            <div>
                <div class="font-bold text-white text-sm leading-tight">Avtor24 Bot</div>
                <div class="text-xs text-gray-500">Dashboard</div>
            </div>
        </div>

        <!-- Nav Links -->
        <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto sidebar-scroll">
            <template x-for="item in navItems" :key="item.page">
                <a :href="'#' + item.page"
                   @click="navigate(item.page); sidebarOpen=false"
                   :class="currentPage === item.page ? 'bg-accent-600/15 text-accent-400 border-accent-600/30' : 'text-gray-400 hover:bg-surface-700 hover:text-gray-200 border-transparent'"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all border cursor-pointer">
                    <span x-html="item.icon" class="w-5 h-5 flex-shrink-0"></span>
                    <span x-text="item.label"></span>
                    <span x-show="item.page === 'notifications' && unreadCount > 0"
                          class="ml-auto bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1.5"
                          x-text="unreadCount"></span>
                </a>
            </template>
        </nav>

        <!-- Bot Status Footer -->
        <div class="px-4 py-4 border-t border-gray-800/60">
            <div class="flex items-center gap-2 mb-3">
                <span :class="botRunning ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full animate-pulse"></span>
                <span class="text-xs text-gray-400" x-text="botRunning ? 'Бот работает' : 'Бот остановлен'"></span>
            </div>
            <button @click="toggleBot()" :class="botRunning ? 'bg-red-500/10 text-red-400 hover:bg-red-500/20 border-red-500/20' : 'bg-green-500/10 text-green-400 hover:bg-green-500/20 border-green-500/20'"
                    class="w-full py-2 rounded-lg text-xs font-medium border transition">
                <span x-text="botRunning ? 'Остановить' : 'Запустить'"></span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="lg:ml-64 min-h-screen flex flex-col">

        <!-- Top Bar -->
        <header class="sticky top-0 z-30 bg-surface-900/80 backdrop-blur-lg border-b border-gray-800/40">
            <div class="flex items-center justify-between px-4 lg:px-6 h-14">
                <!-- Burger -->
                <button @click="sidebarOpen = !sidebarOpen" class="lg:hidden p-2 rounded-lg hover:bg-surface-700 text-gray-400">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/>
                    </svg>
                </button>

                <!-- Page Title -->
                <h1 class="text-lg font-semibold text-white hidden lg:block" x-text="pageTitle"></h1>

                <!-- Right Actions -->
                <div class="flex items-center gap-3">
                    <!-- Uptime -->
                    <span class="text-xs text-gray-500 hidden sm:inline" x-text="'Uptime: ' + formatUptime(uptime)"></span>

                    <!-- Notifications Bell -->
                    <button @click="navigate('notifications')" class="relative p-2 rounded-lg hover:bg-surface-700 text-gray-400 transition">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0"/>
                        </svg>
                        <span x-show="unreadCount > 0"
                              class="absolute -top-0.5 -right-0.5 bg-red-500 text-white text-[10px] font-bold rounded-full min-w-[16px] h-4 flex items-center justify-center px-1"
                              x-text="unreadCount > 99 ? '99+' : unreadCount"></span>
                    </button>

                    <!-- Logout -->
                    <button @click="logout()" class="p-2 rounded-lg hover:bg-surface-700 text-gray-400 transition" title="Выйти">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="flex-1 p-4 lg:p-6">

            <!-- ==================== OVERVIEW ==================== -->
            <div x-show="currentPage === 'overview'" x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

                <!-- Stat Cards Row 1 -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="stat-card">
                        <div class="stat-label">Баланс Автор24</div>
                        <div class="stat-value" x-text="fmt(stats.balance_rub || 0) + ' R'"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Доход сегодня</div>
                        <div class="stat-value text-green-400" x-text="fmt(stats.income_today || 0) + ' R'"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Доход за неделю</div>
                        <div class="stat-value" x-text="fmt(stats.income_week || 0) + ' R'"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Доход всего</div>
                        <div class="stat-value text-accent-400" x-text="fmt(stats.income_total || 0) + ' R'"></div>
                    </div>
                </div>

                <!-- Stat Cards Row 2 -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="stat-card">
                        <div class="stat-label">Активных заказов</div>
                        <div class="stat-value" x-text="stats.active_orders || 0"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ставок в ожидании</div>
                        <div class="stat-value" x-text="(stats.bids_pending || 0) + ' / ' + (stats.bids_total || 0)"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">API расход сегодня</div>
                        <div class="stat-value text-yellow-400" x-text="'$' + (stats.api_cost_today_usd || 0).toFixed(2)"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Чистая прибыль</div>
                        <div class="stat-value text-green-400" x-text="fmt((stats.income_today || 0) - ((stats.api_cost_today_usd || 0) * 90)) + ' R'"></div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid lg:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h3 class="card-title">Доход по дням</h3>
                        <div class="h-64">
                            <canvas id="incomeChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Заказы по дням</h3>
                        <div class="h-64">
                            <canvas id="ordersChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Live Event Feed -->
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="card-title mb-0">Лента событий</h3>
                        <span class="flex items-center gap-1.5 text-xs text-green-400">
                            <span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span>
                            Live
                        </span>
                    </div>
                    <div class="space-y-2 max-h-80 overflow-y-auto sidebar-scroll" id="eventFeed">
                        <template x-for="ev in events.slice(0, 50)" :key="ev.id || ev.created_at">
                            <div class="flex items-start gap-3 px-3 py-2 rounded-lg hover:bg-surface-700/50 transition text-sm">
                                <span class="flex-shrink-0 mt-0.5" x-html="notifIcon(ev.type)"></span>
                                <div class="min-w-0 flex-1">
                                    <span class="text-gray-300" x-text="ev.title"></span>
                                </div>
                                <span class="text-xs text-gray-600 flex-shrink-0" x-text="timeAgo(ev.created_at)"></span>
                            </div>
                        </template>
                        <div x-show="events.length === 0" class="text-center py-8 text-gray-600 text-sm">
                            Нет событий
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== ORDERS ==================== -->
            <div x-show="currentPage === 'orders'" x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

                <!-- Status Tabs -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <template x-for="tab in orderTabs" :key="tab.label">
                        <button @click="ordersFilter.status = tab.value; loadOrders()"
                                :class="ordersFilter.status === tab.value ? 'bg-accent-600 text-white' : 'bg-surface-800 text-gray-400 hover:text-gray-200'"
                                class="px-4 py-1.5 rounded-lg text-sm font-medium transition" x-text="tab.label">
                        </button>
                    </template>
                </div>

                <!-- Orders Table -->
                <div class="card overflow-hidden p-0">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-800/60">
                                    <th class="th-cell">#</th>
                                    <th class="th-cell text-left">Тема</th>
                                    <th class="th-cell">Тип</th>
                                    <th class="th-cell">Статус</th>
                                    <th class="th-cell">Цена</th>
                                    <th class="th-cell">Доход</th>
                                    <th class="th-cell">Уник.%</th>
                                    <th class="th-cell">Дедлайн</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="order in ordersList" :key="order.id">
                                    <tr @click="openOrderDetail(order.id)" class="border-b border-gray-800/30 hover:bg-surface-700/40 cursor-pointer transition">
                                        <td class="td-cell text-gray-500" x-text="order.id"></td>
                                        <td class="td-cell text-left max-w-[240px]">
                                            <div class="truncate text-gray-200" x-text="order.title"></div>
                                            <div class="text-xs text-gray-500 truncate" x-text="order.subject"></div>
                                        </td>
                                        <td class="td-cell">
                                            <span class="text-xs text-gray-400" x-text="order.work_type"></span>
                                        </td>
                                        <td class="td-cell">
                                            <span :class="statusClass(order.status)" class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium" x-text="statusLabel(order.status)"></span>
                                        </td>
                                        <td class="td-cell" x-text="order.bid_price ? fmt(order.bid_price) + 'R' : '—'"></td>
                                        <td class="td-cell text-green-400" x-text="order.income_rub ? fmt(order.income_rub) + 'R' : '—'"></td>
                                        <td class="td-cell" x-text="order.uniqueness_percent ? order.uniqueness_percent.toFixed(1) + '%' : '—'"></td>
                                        <td class="td-cell text-xs text-gray-500" x-text="order.deadline ? formatDate(order.deadline) : '—'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="ordersList.length === 0" class="text-center py-12 text-gray-600">Нет заказов</div>

                    <!-- Pagination -->
                    <div x-show="ordersPagination.pages > 1" class="flex items-center justify-between px-4 py-3 border-t border-gray-800/40">
                        <span class="text-xs text-gray-500" x-text="'Всего: ' + ordersPagination.total"></span>
                        <div class="flex gap-1">
                            <button @click="ordersFilter.page--; loadOrders()" :disabled="ordersFilter.page <= 1"
                                    class="px-3 py-1 rounded-lg bg-surface-700 text-gray-400 text-xs hover:bg-surface-750 disabled:opacity-30 transition">
                                Назад
                            </button>
                            <span class="px-3 py-1 text-xs text-gray-400" x-text="ordersFilter.page + ' / ' + ordersPagination.pages"></span>
                            <button @click="ordersFilter.page++; loadOrders()" :disabled="ordersFilter.page >= ordersPagination.pages"
                                    class="px-3 py-1 rounded-lg bg-surface-700 text-gray-400 text-xs hover:bg-surface-750 disabled:opacity-30 transition">
                                Далее
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Order Detail Modal -->
                <div x-show="orderDetail" x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-150"
                     class="fixed inset-0 z-50 flex items-start justify-center p-4 pt-16 bg-black/70" @click.self="orderDetail=null">
                    <div class="bg-surface-800 rounded-2xl w-full max-w-3xl max-h-[80vh] overflow-y-auto border border-gray-800/60 sidebar-scroll">
                        <template x-if="orderDetail">
                            <div class="p-6">
                                <!-- Header -->
                                <div class="flex items-start justify-between mb-6">
                                    <div>
                                        <h2 class="text-lg font-semibold text-white" x-text="orderDetail.order.title"></h2>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span :class="statusClass(orderDetail.order.status)" class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium" x-text="statusLabel(orderDetail.order.status)"></span>
                                            <span class="text-xs text-gray-500" x-text="orderDetail.order.work_type"></span>
                                            <span class="text-xs text-gray-500" x-text="orderDetail.order.subject"></span>
                                        </div>
                                    </div>
                                    <button @click="orderDetail=null" class="p-1 rounded-lg hover:bg-surface-700 text-gray-400">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
                                    </button>
                                </div>

                                <!-- Info Grid -->
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                                    <div class="mini-card">
                                        <div class="text-xs text-gray-500">Ставка</div>
                                        <div class="text-sm font-medium text-white" x-text="orderDetail.order.bid_price ? fmt(orderDetail.order.bid_price) + 'R' : '—'"></div>
                                    </div>
                                    <div class="mini-card">
                                        <div class="text-xs text-gray-500">Доход</div>
                                        <div class="text-sm font-medium text-green-400" x-text="orderDetail.order.income_rub ? fmt(orderDetail.order.income_rub) + 'R' : '—'"></div>
                                    </div>
                                    <div class="mini-card">
                                        <div class="text-xs text-gray-500">Уникальность</div>
                                        <div class="text-sm font-medium" x-text="orderDetail.order.uniqueness_percent ? orderDetail.order.uniqueness_percent.toFixed(1) + '%' : '—'"></div>
                                    </div>
                                    <div class="mini-card">
                                        <div class="text-xs text-gray-500">API стоимость</div>
                                        <div class="text-sm font-medium text-yellow-400" x-text="orderDetail.order.api_cost_usd ? '$' + orderDetail.order.api_cost_usd.toFixed(4) : '—'"></div>
                                    </div>
                                </div>

                                <!-- Description -->
                                <div class="mb-6" x-show="orderDetail.order.description">
                                    <h4 class="text-sm font-medium text-gray-400 mb-2">Описание</h4>
                                    <div class="text-sm text-gray-300 bg-surface-900 rounded-xl p-4 whitespace-pre-wrap max-h-40 overflow-y-auto sidebar-scroll" x-text="orderDetail.order.description"></div>
                                </div>

                                <!-- Chat Messages -->
                                <div class="mb-6" x-show="orderDetail.messages && orderDetail.messages.length">
                                    <h4 class="text-sm font-medium text-gray-400 mb-2">Переписка</h4>
                                    <div class="bg-surface-900 rounded-xl p-4 space-y-2 max-h-60 overflow-y-auto sidebar-scroll">
                                        <template x-for="msg in orderDetail.messages" :key="msg.id">
                                            <div :class="msg.direction === 'outgoing' ? 'ml-8' : 'mr-8'">
                                                <div :class="msg.direction === 'outgoing' ? 'bg-accent-600/20 border-accent-600/20' : 'bg-surface-700 border-gray-700/50'"
                                                     class="rounded-xl p-3 border">
                                                    <div class="text-sm text-gray-200" x-text="msg.text"></div>
                                                    <div class="flex items-center gap-2 mt-1">
                                                        <span class="text-[10px] text-gray-500" x-text="timeAgo(msg.created_at)"></span>
                                                        <span x-show="msg.is_auto_reply" class="text-[10px] text-accent-400">авто</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex gap-2">
                                    <button @click="regenOrder(orderDetail.order.id)" class="px-4 py-2 rounded-xl bg-accent-600/15 text-accent-400 hover:bg-accent-600/25 text-sm font-medium border border-accent-600/20 transition">
                                        Перегенерировать
                                    </button>
                                    <button @click="stopOrder(orderDetail.order.id)" class="px-4 py-2 rounded-xl bg-red-500/10 text-red-400 hover:bg-red-500/20 text-sm font-medium border border-red-500/20 transition">
                                        Остановить
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- ==================== ANALYTICS ==================== -->
            <div x-show="currentPage === 'analytics'" x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

                <!-- Period Selector -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <template x-for="p in analyticsPeriods" :key="p.value">
                        <button @click="analyticsPeriod = p.value; loadAnalytics()"
                                :class="analyticsPeriod === p.value ? 'bg-accent-600 text-white' : 'bg-surface-800 text-gray-400 hover:text-gray-200'"
                                class="px-4 py-1.5 rounded-lg text-sm font-medium transition" x-text="p.label">
                        </button>
                    </template>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="stat-card">
                        <div class="stat-label">Общий доход</div>
                        <div class="stat-value text-green-400" x-text="fmt(analyticsData.total_income_rub || 0) + ' R'"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Расход API</div>
                        <div class="stat-value text-yellow-400" x-text="'$' + (analyticsData.total_api_cost_usd || 0).toFixed(2)"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Принято ставок</div>
                        <div class="stat-value" x-text="(analyticsData.total_accepted || 0) + ' / ' + (analyticsData.total_bids || 0)"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ROI</div>
                        <div class="stat-value text-accent-400" x-text="(analyticsData.roi || 0).toFixed(0) + 'x'"></div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid lg:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h3 class="card-title">Доход по дням</h3>
                        <div class="h-64"><canvas id="analyticsIncomeChart"></canvas></div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Использование API по моделям</h3>
                        <div class="h-64"><canvas id="analyticsApiChart"></canvas></div>
                    </div>
                </div>

                <!-- Token Usage Table -->
                <div class="card" x-show="analyticsData.api_by_model">
                    <h3 class="card-title">Детализация API</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-800/60">
                                    <th class="th-cell text-left">Модель</th>
                                    <th class="th-cell">Input токенов</th>
                                    <th class="th-cell">Output токенов</th>
                                    <th class="th-cell">Стоимость</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="item in (analyticsData.api_by_model || [])" :key="item.model">
                                    <tr class="border-b border-gray-800/30">
                                        <td class="td-cell text-left font-mono text-accent-400" x-text="item.model"></td>
                                        <td class="td-cell" x-text="fmt(item.input_tokens || 0)"></td>
                                        <td class="td-cell" x-text="fmt(item.output_tokens || 0)"></td>
                                        <td class="td-cell text-yellow-400" x-text="'$' + (item.cost_usd || 0).toFixed(4)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ==================== NOTIFICATIONS ==================== -->
            <div x-show="currentPage === 'notifications'" x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

                <!-- Filter Tabs -->
                <div class="flex flex-wrap items-center gap-2 mb-4">
                    <template x-for="tab in notifTabs" :key="tab.label">
                        <button @click="notifFilter = tab.value; loadNotifications()"
                                :class="notifFilter === tab.value ? 'bg-accent-600 text-white' : 'bg-surface-800 text-gray-400 hover:text-gray-200'"
                                class="px-4 py-1.5 rounded-lg text-sm font-medium transition" x-text="tab.label">
                        </button>
                    </template>
                    <button @click="markAllRead()" x-show="unreadCount > 0"
                            class="ml-auto px-4 py-1.5 rounded-lg text-sm font-medium bg-surface-800 text-gray-400 hover:text-gray-200 transition">
                        Прочитать все
                    </button>
                </div>

                <!-- Notifications List -->
                <div class="space-y-2">
                    <template x-for="n in notifList" :key="n.id">
                        <div :class="n.is_read ? 'bg-surface-800/60' : 'bg-surface-800 border-l-2 border-l-accent-500'"
                             class="rounded-xl px-4 py-3 flex items-start gap-3 transition hover:bg-surface-700/50">
                            <span class="flex-shrink-0 mt-1" x-html="notifIcon(n.type)"></span>
                            <div class="min-w-0 flex-1">
                                <div class="text-sm text-gray-200" x-text="n.title"></div>
                                <div class="text-xs text-gray-500 mt-1" x-text="timeAgo(n.created_at)"></div>
                            </div>
                            <button x-show="!n.is_read" @click.stop="markRead([n.id])"
                                    class="text-xs text-gray-500 hover:text-accent-400 transition flex-shrink-0">
                                Прочитано
                            </button>
                        </div>
                    </template>
                    <div x-show="notifList.length === 0" class="text-center py-12 text-gray-600 text-sm">Нет уведомлений</div>
                </div>
            </div>

            <!-- ==================== LOGS ==================== -->
            <div x-show="currentPage === 'logs'" x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

                <!-- Filters -->
                <div class="flex flex-wrap items-center gap-2 mb-4">
                    <template x-for="tab in logTabs" :key="tab.label">
                        <button @click="logFilter = tab.value; loadLogs()"
                                :class="logFilter === tab.value ? 'bg-accent-600 text-white' : 'bg-surface-800 text-gray-400 hover:text-gray-200'"
                                class="px-3 py-1.5 rounded-lg text-xs font-medium transition" x-text="tab.label">
                        </button>
                    </template>
                    <div class="ml-auto flex items-center gap-2">
                        <label class="flex items-center gap-1.5 text-xs text-gray-400 cursor-pointer">
                            <input type="checkbox" x-model="logAutoScroll" class="w-3.5 h-3.5 rounded bg-surface-900 border-gray-600 text-accent-600">
                            Автоскролл
                        </label>
                    </div>
                </div>

                <!-- Log Terminal -->
                <div class="card font-mono text-xs p-0">
                    <div class="flex items-center gap-2 px-4 py-2 border-b border-gray-800/50">
                        <span class="w-2.5 h-2.5 rounded-full bg-red-500/70"></span>
                        <span class="w-2.5 h-2.5 rounded-full bg-yellow-500/70"></span>
                        <span class="w-2.5 h-2.5 rounded-full bg-green-500/70"></span>
                        <span class="ml-2 text-gray-500 text-[10px]">action_logs</span>
                        <span class="flex items-center gap-1 ml-auto text-green-400 text-[10px]">
                            <span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span>
                            live
                        </span>
                    </div>
                    <div id="logTerminal" class="p-4 h-[600px] overflow-y-auto sidebar-scroll space-y-0.5">
                        <template x-for="log in filteredLogs" :key="log.id || log.timestamp">
                            <div class="flex gap-2 leading-relaxed hover:bg-surface-700/30 px-1 rounded">
                                <span class="text-gray-600 flex-shrink-0 w-[70px] text-right" x-text="formatTime(log.created_at || log.timestamp)"></span>
                                <span :class="logActionClass(log.action)" class="flex-shrink-0 font-bold w-[90px] text-center" x-text="'[' + (log.action || 'INFO').toUpperCase() + ']'"></span>
                                <span class="text-gray-300 break-words min-w-0" x-text="log.details"></span>
                            </div>
                        </template>
                        <div x-show="logsList.length === 0" class="text-center py-8 text-gray-600">Нет логов</div>
                    </div>
                </div>
            </div>

            <!-- ==================== SETTINGS ==================== -->
            <div x-show="currentPage === 'settings'" x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

                <form @submit.prevent="saveSettings()">
                    <!-- Bot Section -->
                    <div class="card mb-6">
                        <h3 class="card-title">Бот</h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <label class="setting-group">
                                <span class="setting-label">Автоматический режим</span>
                                <select x-model="settingsData.auto_bid" class="setting-input">
                                    <option value="true">Включён</option>
                                    <option value="false">Выключен</option>
                                </select>
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Интервал сканирования (сек)</span>
                                <input type="number" x-model="settingsData.scan_interval_seconds" class="setting-input" min="30" max="300">
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Макс. заказов одновременно</span>
                                <input type="number" x-model="settingsData.max_concurrent_orders" class="setting-input" min="1" max="10">
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Мин. score для авто-ставки</span>
                                <input type="number" x-model="settingsData.min_score_for_bid" class="setting-input" min="0" max="100">
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Макс. ставок в день</span>
                                <input type="number" x-model="settingsData.max_bids_per_day" class="setting-input" min="1" max="50">
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Рабочие часы (начало)</span>
                                <input type="number" x-model="settingsData.work_hours_start" class="setting-input" min="0" max="23">
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Рабочие часы (конец)</span>
                                <input type="number" x-model="settingsData.work_hours_end" class="setting-input" min="0" max="24">
                            </label>
                        </div>
                    </div>

                    <!-- Pricing Section -->
                    <div class="card mb-6">
                        <h3 class="card-title">Ценообразование</h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <label class="setting-group">
                                <span class="setting-label">Мин. цена заказа (руб)</span>
                                <input type="number" x-model="settingsData.min_price_rub" class="setting-input">
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Макс. цена заказа (руб)</span>
                                <input type="number" x-model="settingsData.max_price_rub" class="setting-input">
                            </label>
                        </div>
                    </div>

                    <!-- AI Section -->
                    <div class="card mb-6">
                        <h3 class="card-title">AI / OpenAI</h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <label class="setting-group">
                                <span class="setting-label">Основная модель</span>
                                <select x-model="settingsData.openai_model_main" class="setting-input">
                                    <option value="gpt-4o">gpt-4o</option>
                                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                                    <option value="gpt-4-turbo">gpt-4-turbo</option>
                                </select>
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Модель для анализа</span>
                                <select x-model="settingsData.openai_model_fast" class="setting-input">
                                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                                    <option value="gpt-4o">gpt-4o</option>
                                </select>
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Температура генерации</span>
                                <input type="number" x-model="settingsData.generation_temperature" class="setting-input" min="0.1" max="1.0" step="0.1">
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Макс. бюджет API в день ($)</span>
                                <input type="number" x-model="settingsData.max_api_budget_day_usd" class="setting-input" min="1" max="100">
                            </label>
                        </div>
                    </div>

                    <!-- Antiplagiat Section -->
                    <div class="card mb-6">
                        <h3 class="card-title">Антиплагиат</h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <label class="setting-group">
                                <span class="setting-label">Система по умолчанию</span>
                                <select x-model="settingsData.antiplagiat_default_system" class="setting-input">
                                    <option value="textru">text.ru</option>
                                    <option value="etxt">ETXT</option>
                                </select>
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Макс. итераций рерайта</span>
                                <input type="number" x-model="settingsData.max_rewrite_iterations" class="setting-input" min="1" max="5">
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Запас уникальности (%)</span>
                                <input type="number" x-model="settingsData.uniqueness_buffer_percent" class="setting-input" min="0" max="20">
                            </label>
                        </div>
                    </div>

                    <!-- Anti-Ban Section -->
                    <div class="card mb-6">
                        <h3 class="card-title">Антибан</h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <label class="setting-group">
                                <span class="setting-label">Мин. задержка (сек)</span>
                                <input type="number" x-model="settingsData.speed_limit_min_delay" class="setting-input" min="5" max="300">
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Макс. задержка (сек)</span>
                                <input type="number" x-model="settingsData.speed_limit_max_delay" class="setting-input" min="10" max="600">
                            </label>
                        </div>
                    </div>

                    <!-- Templates Section -->
                    <div class="card mb-6">
                        <h3 class="card-title">Шаблоны сообщений</h3>
                        <div class="space-y-4">
                            <label class="setting-group">
                                <span class="setting-label">Комментарий к ставке</span>
                                <textarea x-model="settingsData.bid_comment_template" class="setting-input min-h-[80px] resize-y" rows="2"></textarea>
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Приветствие в чате</span>
                                <textarea x-model="settingsData.chat_greeting_template" class="setting-input min-h-[80px] resize-y" rows="2"></textarea>
                            </label>
                            <label class="setting-group">
                                <span class="setting-label">Сообщение при доставке</span>
                                <textarea x-model="settingsData.delivery_message_template" class="setting-input min-h-[80px] resize-y" rows="2"></textarea>
                            </label>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="flex justify-end">
                        <button type="submit" class="px-6 py-2.5 rounded-xl bg-accent-600 hover:bg-accent-700 text-white font-medium transition">
                            Сохранить настройки
                        </button>
                    </div>
                </form>
            </div>

            <!-- ==================== CHATS ==================== -->
            <div x-show="currentPage === 'chats'" x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

                <div class="card p-0 overflow-hidden" style="height: calc(100vh - 160px);">
                    <div class="flex h-full">
                        <!-- Chat List -->
                        <div class="w-72 flex-shrink-0 border-r border-gray-800/50 flex flex-col">
                            <div class="px-4 py-3 border-b border-gray-800/40 text-sm font-medium text-gray-400">
                                Чаты
                            </div>
                            <div class="flex-1 overflow-y-auto sidebar-scroll">
                                <template x-for="chat in chatsList" :key="chat.id">
                                    <div @click="openChat(chat)" :class="activeChat && activeChat.id === chat.id ? 'bg-surface-700' : 'hover:bg-surface-700/50'"
                                         class="px-4 py-3 cursor-pointer transition border-b border-gray-800/20">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-sm text-white font-medium truncate" x-text="chat.title || '#' + chat.avtor24_id"></span>
                                            <span :class="statusClass(chat.status)" class="text-[10px] px-1.5 py-0.5 rounded font-medium" x-text="statusLabel(chat.status)"></span>
                                        </div>
                                        <div class="text-xs text-gray-500 truncate" x-text="chat.last_message || 'Нет сообщений'"></div>
                                    </div>
                                </template>
                                <div x-show="chatsList.length === 0" class="text-center py-8 text-gray-600 text-xs">Нет чатов</div>
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div class="flex-1 flex flex-col">
                            <template x-if="activeChat">
                                <div class="flex flex-col h-full">
                                    <!-- Chat Header -->
                                    <div class="px-4 py-3 border-b border-gray-800/40 flex items-center justify-between">
                                        <div>
                                            <div class="text-sm font-medium text-white" x-text="activeChat.title"></div>
                                            <div class="text-xs text-gray-500" x-text="activeChat.customer_username || activeChat.avtor24_id"></div>
                                        </div>
                                    </div>
                                    <!-- Messages -->
                                    <div class="flex-1 overflow-y-auto p-4 space-y-3 sidebar-scroll" id="chatMessages">
                                        <template x-for="msg in chatMessages" :key="msg.id">
                                            <div :class="msg.direction === 'outgoing' ? 'flex justify-end' : 'flex justify-start'">
                                                <div :class="msg.direction === 'outgoing' ? 'bg-accent-600/20 border-accent-600/20' : 'bg-surface-700 border-gray-700/50'"
                                                     class="rounded-2xl px-4 py-2.5 max-w-[70%] border">
                                                    <div class="text-sm text-gray-200" x-text="msg.text"></div>
                                                    <div class="flex items-center gap-2 mt-1">
                                                        <span class="text-[10px] text-gray-500" x-text="timeAgo(msg.created_at)"></span>
                                                        <span x-show="msg.is_auto_reply" class="text-[10px] text-accent-400 bg-accent-600/10 px-1.5 rounded">авто</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    <!-- Input -->
                                    <div class="p-4 border-t border-gray-800/40">
                                        <form @submit.prevent="sendChatMessage()" class="flex gap-2">
                                            <input type="text" x-model="chatInput" placeholder="Введите сообщение..."
                                                   class="flex-1 bg-surface-900 border border-gray-700 rounded-xl px-4 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-accent-500 transition">
                                            <button type="submit" class="px-4 py-2.5 rounded-xl bg-accent-600 hover:bg-accent-700 text-white text-sm font-medium transition">
                                                Отправить
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </template>
                            <template x-if="!activeChat">
                                <div class="flex-1 flex items-center justify-center text-gray-600 text-sm">
                                    Выберите чат
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Toast Notifications -->
    <div class="fixed bottom-4 right-4 z-[60] space-y-2" id="toastContainer">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible" x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-x-8" x-transition:enter-end="opacity-100 translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                 :class="toast.type === 'error' ? 'border-red-500/30' : 'border-accent-500/30'"
                 class="bg-surface-800 border rounded-xl px-4 py-3 shadow-xl max-w-sm">
                <div class="text-sm text-gray-200" x-text="toast.message"></div>
            </div>
        </template>
    </div>

    <!-- Notification Sound -->
    <audio id="notifSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbsGczIjqN0teleEAtS4bR4cF5Rx1El9LhqHVFJ1OW1OaxeUkjU5jU5q95RiRUmtPouH5GIliZ0uW2fUUiWJvT6Ll+RSJZm9PouX5FIlia0+i5fUYjWJrR57l+RSNYm9LouX1HI1ia0ee4fUYjWZzS6Ll+RSRYm9LouX1HIlia0+i5fUYjWJrR57l+RSNYm9PouX5FI1ma0+i5fUYjWJrR57l+RSRYm9PouX5FI1ia0ui5fUYjWJrR57h9RiNYm9LouX5FI1ia0ui5fUYjWJvS6Ll+RSNYm9LouX1HI1ia0+i5fUYjWJrR57l9RiNYm9PouX5FI1ia0+i5fUcjWJrR6Ll9RSRYm9LouX1GI1ia0+i5fUYjWJrR57l+RSNYm9PouX5GI1ma0ui5fkYjWJrR57l9RiRYm9LouX1GI1ia0+e5fUYjWJrR6Ll+RSNYm9PouX1HI1ia0ui5fUYj" type="audio/wav">
    </audio>

    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script src="/dashboard/static/app.js"></script>
</body>
</html>
